from typing import Any, cast

from django.core.management.base import BaseCommand, CommandParser

from ..generators.file import (
    EnvFileGenerator,
    FileGenerator,
    RandomStringGenerator,
    VercelJSONFileGenerator,
)


class Command(BaseCommand):
    help = "Generate various project configuration files and secrets."
    requires_system_checks: bool = cast(bool, [])

    GENERATORS: dict[str, type[FileGenerator]] = {
        "random": RandomStringGenerator,
        "vercel": VercelJSONFileGenerator,
        "env": EnvFileGenerator,
    }

    def add_arguments(self, parser: CommandParser) -> None:
        """Define command-line arguments.

        Args:
            parser: The argument parser to add arguments to.
        """
        parser.add_argument(
            "file",
            type=str,
            choices=self.GENERATORS.keys(),
            help="Specify which file to create (random, vercel, env)",
        )

        # Random generator option
        parser.add_argument(
            "--no-clipboard",
            action="store_true",
            help="Skip copying the generated string to clipboard (only for 'random' generator)",
        )

        # Vercel and env generator option
        parser.add_argument(
            "-f",
            "--force",
            "--overwrite",
            dest="force",
            action="store_true",
            help="Overwrite existing files without prompting (for 'vercel' and 'env' generators)",
        )

        # Env generator specific options
        parser.add_argument(
            "-p",
            "--path",
            dest="path",
            type=str,
            default=None,
            help="Custom path for the .env file (only for 'env' generator, default: BASE_DIR/.env)",
        )
        parser.add_argument(
            "--uncomment",
            action="store_true",
            help="Leave variables uncommented (active by default) in .env file (only for 'env' generator)",
        )

    def handle(self, *args: Any, **options: Any) -> None:
        """Handle the command execution.

        Dispatches to the appropriate generator based on the 'generator' argument.
        Validates that generator-specific flags are used only with their intended generator.

        Args:
            *args: Unused positional arguments.
            **options: Command options including:
                - generator (str): The name of the generator to use.
                - no_clipboard (bool): For 'random' generator only.
                - force (bool): For 'vercel' and 'env' generators.
                - path (str): For 'env' generator only.
                - uncomment (bool): For 'env' generator only.
        """
        generator_name: str = options["generator"]

        # Validate --no-clipboard is only used with random generator
        if options.get("no_clipboard", False) and generator_name != "random":
            self.stdout.write(
                self.style.ERROR(
                    f"--no-clipboard is only valid for the 'random' generator, not '{generator_name}'"
                )
            )
            return

        # Validate --path is only used with env generator
        if options.get("path") is not None and generator_name != "env":
            self.stdout.write(
                self.style.ERROR(
                    f"--path is only valid for the 'env' generator, not '{generator_name}'"
                )
            )
            return

        # Validate --uncomment is only used with env generator
        if options.get("uncomment", False) and generator_name != "env":
            self.stdout.write(
                self.style.ERROR(
                    f"--uncomment is only valid for the 'env' generator, not '{generator_name}'"
                )
            )
            return

        generator_class = self.GENERATORS[generator_name]
        generator: FileGenerator = generator_class(self)
        generator.handle(*args, **options)
